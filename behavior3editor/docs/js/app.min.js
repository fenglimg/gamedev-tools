window.b3e=window.b3e||{},window.b3e.draw=window.b3e.draw||{},window.b3e.editor=window.b3e.editor||{},window.b3e.project=window.b3e.project||{},window.b3e.tree=window.b3e.tree||{},window.b3e.VERSION="0.3.0";
(()=>{function t(t){this.Container_constructor();var i=t.prototype||t;this.id=b3.createUUID(),this.node=t,this.name=i.name,this.title=i.title||this.name,this.category=i.category,this.description=i.description||"",this.properties=tine.merge({},i.properties),this._settings=null,this._inConnection=null,this._outConnections=[],this._isSelected=null,this._isDragging=null,this._dragOffsetX=null,this._dragOffsetY=null,this._width=null,this._height=null,this._displayShape=new createjs.Shape,this._displaySymbol=null,this._displayShadow=null}var i=createjs.extend(t,createjs.Container);i._applySettings=function(t){this._settings=t;t=this._settings.get("selection_color");this._displayShadow=new createjs.Shadow(t,0,0,5),this._redraw()},i._redraw=function(){var t=this.name,i=this.category.toLowerCase(),s=b3e.draw.SHAPES[i],t=b3e.draw.SYMBOLS[t]||b3e.draw.textSymbol;this._width=this._settings.get("block_"+i+"_width"),this._height=this._settings.get("block_"+i+"_height"),this.removeAllChildren(),this._displaySymbol=t(this,this._settings),this._displayShape.graphics.clear(),this._displayShape=s(this,this._settings),this.addChild(this._displayShape),this.addChild(this._displaySymbol)},i._copy=function(){var t=new b3e.Block(this.node);return t.category=this.category,t.title=this.title,t.description=this.description,t.properties=tine.merge({},this.properties),t._applySettings(this._settings),t.x=this.x,t.y=this.y,t},i._snap=function(){var t=this._settings.get("snap_x"),i=this._settings.get("snap_y"),s=this.x%t,h=this.y%i;h<0&&(h=i+h),this.x-=s=s<0?t+s:s,this.y-=h},i._getInAnchorPosition=function(){return{x:this.x-this._width/2-this._settings.get("anchor_offset_x"),y:this.y-this._height/2-this._settings.get("anchor_offset_x")}},i._getOutAnchorPosition=function(){return{x:this.x+this._width/2+this._settings.get("anchor_offset_x"),y:this.y+this._height/2+this._settings.get("anchor_offset_x")}},i._select=function(){this._isSelected=!0,this._displayShape.shadow=this._displayShadow},i._deselect=function(){this._isSelected=!1,this._displayShape.shadow=null},i._collapse=function(){},i._expand=function(){},i._hitTest=function(t,i){return this._displayShape.hitTest(t-this.x,i-this.y)},i._hitBody=function(t,i){return"horizontal"===this._settings.get("layout")?Math.abs(t-this.x)<this._width/2:Math.abs(i-this.y)<this._height/2},i._hitInAnchor=function(t,i){return"horizontal"===this._settings.get("layout")?(t=t-this.x,Math.abs(t)>this._width/2&&t<0):(t=i-this.y,Math.abs(t)>this._height/2&&t<0)},i._hitOutAnchor=function(t,i){return"horizontal"===this._settings.get("layout")?(t=t-this.x,Math.abs(t)>this._width/2&&0<t):(t=i-this.y,Math.abs(t)>this._height/2&&0<t)},i._isContainedIn=function(t,i,s,h){return t<this.x-this._width/2&&i<this.y-this._height/2&&s>this.x+this._width/2&&h>this.y+this._height/2},i.getTitle=function(){var t=this.title||this.name,s=this;return t.replace(/(<\w+>)/g,function(t,i){i=i.substring(1,i.length-1);return s.properties.hasOwnProperty(i)?s.properties[i]:t})},i.traversal=function(t,i){for(var s=[this];0<s.length;){var h=s.pop();if(!1===t.call(i,h))return;for(var e=h._outConnections.length-1;0<=e;e--){var n=h._outConnections[e];n._outBlock&&s.push(n._outBlock)}}},b3e.Block=createjs.promote(t,"Container")})();
b3e.Command=function(n,t){if(3!==n.length)throw"Invalid undo command, must have [target, method, args]";if(3!==t.length)throw"Invalid redo command, must have [target, method, args]";function o(n,t,o){t.apply(n,o)}this.context=null,this.redo=function(){o(t[0],t[1],t[2])},this.undo=function(){o(n[0],n[1],n[2])}},b3e.Commands=function(t){this.context=null,this.redo=function(){for(var n=0;n<t.length;n++)t[n].redo()},this.undo=function(){for(var n=t.length-1;0<=n;n--)t[n].undo()}};
(()=>{function t(){this.Shape_constructor(),this._settings=null,this._inBlock=null,this._outBlock=null}var o=createjs.extend(t,createjs.Shape);o._applySettings=function(t){this._settings=t,this._redraw()},o._redraw=function(t,o,i,e){var n,r,s,c,h,l,_,a,u,g,k,d;(this._inBlock||t||o)&&(this._outBlock||i||e)&&(l=this._settings,n=this.graphics,r=l.get("connection_width"),s=l.get("connection_color"),c=l.get("anchor_radius")+l.get("anchor_border_width"),h=l.get("anchor_radius")/2,l=l.get("layout"),(k=g=u=a=_=0)===t||t||(d=this._inBlock._getOutAnchorPosition(),o=("horizontal"===l?(t=d.x,this._inBlock):(t=this._inBlock.x,d)).y),0===i||i||(d=this._outBlock._getInAnchorPosition(),e="horizontal"===l?(i=d.x-c,this._outBlock.y):(i=this._outBlock.x,d.y-c)),"horizontal"===l?(_=2.5*(i-t)/4,g=-h):(a=2.5*(e-o)/4,k=-h,u=90),n.clear(),n.setStrokeStyle(r,"round"),n.beginStroke(s),n.moveTo(t,o),n.bezierCurveTo(t+_,o+a,i-_,e-a,i,e),n.beginFill(s),n.drawPolyStar(i+g,e+k,h,3,0,u),n.endFill(),n.endStroke())},b3e.Connection=createjs.promote(t,"Shape")})();

JSON3=JSON3||JSON,String.prototype.format||(String.prototype.format=function(){var o=arguments;return this.replace(/{(\d+)}/g,function(r,t){return void 0!==o[t]?o[t]:r})}),Array.prototype.remove||(Array.prototype.remove=function(){for(var r,t,o=arguments,e=o.length;e&&this.length;)for(r=o[--e];-1!==(t=this.indexOf(r));)this.splice(t,1);return this}),Array.prototype.forEach||(Array.prototype.forEach=function(r,t){var o,e;if(null===this)throw new TypeError(" this is null or not defined");var n,i=Object(this),p=i.length>>>0;if("function"!=typeof r)throw new TypeError(r+" is not a function");for(1<arguments.length&&(o=t),e=0;e<p;)e in i&&(n=i[e],r.call(o,n,e,i)),e++}),Object.keys||(Object.keys=(()=>{var n=Object.prototype.hasOwnProperty,i=!{toString:null}.propertyIsEnumerable("toString"),p=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],f=p.length;return function(r){if("object"!=typeof r&&("function"!=typeof r||null===r))throw new TypeError("Object.keys called on non-object");var t,o,e=[];for(t in r)n.call(r,t)&&e.push(t);if(i)for(o=0;o<f;o++)n.call(r,p[o])&&e.push(p[o]);return e}})());
b3e.Node=function(t){this.spec=null,this.name=null,this.title=null,this.category=null,this.description=null,this.properties={},this.isDefault=!!t,this.copy=function(){var t=new b3e.Node(this.isDefault);return t.spec=this.spec,t.name=this.name,t.title=this.title,t.category=this.category,t.description=this.description,t.properties=this.properties,t}};
b3e.Root={name:"Root",category:"root",title:"A behavior tree"};
(()=>{function t(){this.Shape_constructor(),this._settings=null,this.alpha=.3,this.visible=!1}var e=createjs.extend(t,createjs.Shape);e._applySettings=function(t){this._settings=t,this._redraw()},e._redraw=function(t,e,i,s){var a=this._settings.get("selection_color"),n=this.graphics,h=Math.min(t,i),r=Math.min(e,s),t=Math.abs(t-i),i=Math.abs(e-s);n.clear(),n.beginFill(a),n.drawRect(h,r,t,i),n.endFill()},b3e.SelectionBox=createjs.promote(t,"Shape")})();
b3e.DEFAULT_SETTINGS={zoom_initial:1,zoom_min:.25,zoom_max:2,zoom_step:.25,snap_x:12,snap_y:12,snap_offset_x:0,snap_offset_y:0,layout:"horizontal",max_history:100,background_color:"#171717",selection_color:"#4BB2FD",block_border_color:"#6D6D6D",block_symbol_color:"#333333",anchor_background_color:"#EFEFEF",connection_color:"#6D6D6D",root_color:"#FFFFFF",decorator_color:"#FFFFFF",composite_color:"#FFFFFF",tree_color:"#FFFFFF",action_color:"#FFFFFF",condition_color:"#FFFFFF",connection_width:2,anchor_border_width:2,anchor_radius:7,anchor_offset_x:4,anchor_offset_y:0,block_border_width:2,block_root_width:40,block_root_height:40,block_tree_width:160,block_tree_height:40,block_composite_width:40,block_composite_height:40,block_decorator_width:60,block_decorator_height:60,block_action_width:160,block_action_height:40,block_condition_width:160,block_condition_height:40};
(()=>{function t(){this._dict={}}var i=t.prototype;i.clear=function(){this._dict={}},i.set=function(t,i){this._dict[t]=i},i.get=function(t){return this._dict[t]},i.load=function(t){for(var i in t)this.set(i,t[i])},b3e.SettingsManager=t})();
(()=>{function c(o,r,e,t,a,i,h){o.graphics.beginFill(a),o.graphics.setStrokeStyle(i,"round"),o.graphics.beginStroke(h),o.graphics.drawCircle(r,e,t),o.graphics.endStroke(),o.graphics.endFill()}function g(o,r,e,t,a,i,h){o.graphics.beginFill(a),o.graphics.setStrokeStyle(i,"round"),o.graphics.beginStroke(h),o.graphics.drawRoundRect(-r/2,-e/2,r,e,t),o.graphics.endStroke(),o.graphics.endFill()}b3e.draw.rootShape=function(o,r){var e=o._width,t=o._height,a=r.get("anchor_offset_x"),o=o._displayShape,i=0,h=0;return"horizontal"===r.get("layout")?i=e/2+a:h=t/2+a,c(o,i,h,r.get("anchor_radius"),r.get("anchor_background_color"),r.get("anchor_border_width"),r.get("block_border_color")),g(o,e,t,15,r.get("root_color"),r.get("block_border_width"),r.get("block_border_color")),o},b3e.draw.compositeShape=function(o,r){var e=o._displaySymbol.getBounds(),t=0,e=(e&&(t=e.width+20),Math.max(t,o._width)),t=o._height,a=r.get("anchor_offset_x"),i=o._displayShape,o=(o._width=e,o._height=t,0),h=0;return"horizontal"===r.get("layout")?o=e/2+a:h=t/2+a,c(i,o,h,r.get("anchor_radius"),r.get("anchor_background_color"),r.get("anchor_border_width"),r.get("block_border_color")),c(i,-o,-h,r.get("anchor_radius"),r.get("anchor_background_color"),r.get("anchor_border_width"),r.get("block_border_color")),g(i,e,t,15,r.get("composite_color"),r.get("block_border_width"),r.get("block_border_color")),i},b3e.draw.decoratorShape=function(o,r){var e=o._displaySymbol.getBounds(),t=Math.max(e.width+40,o._width),e=Math.max(e.height+50,o._height),a=r.get("anchor_offset_x"),i=o._displayShape,o=(o._width=t,o._height=e,0),h=0;return"horizontal"===r.get("layout")?o=t/2+a:h=e/2+a,c(i,o,h,r.get("anchor_radius"),r.get("anchor_background_color"),r.get("anchor_border_width"),r.get("block_border_color")),c(i,-o,-h,r.get("anchor_radius"),r.get("anchor_background_color"),r.get("anchor_border_width"),r.get("block_border_color")),a=i,o=t,h=e,t=r.get("decorator_color"),e=r.get("block_border_width"),r=r.get("block_border_color"),a.graphics.beginFill(t),a.graphics.setStrokeStyle(e,"round"),a.graphics.beginStroke(r),a.graphics.moveTo(0,h/2),a.graphics.lineTo(o/2,0),a.graphics.lineTo(0,-h/2),a.graphics.lineTo(-o/2,0),a.graphics.lineTo(0,h/2),a.graphics.endStroke(),a.graphics.endFill(),i},b3e.draw.actionShape=function(o,r){var e=o._displaySymbol.getBounds(),t=Math.max(e.width+15,o._width),e=Math.max(e.height+15,o._height),a=r.get("anchor_offset_x"),i=o._displayShape,o=(o._width=t,o._height=e,0),h=0;return"horizontal"===r.get("layout")?o=t/2+a:h=e/2+a,c(i,-o,-h,r.get("anchor_radius"),r.get("anchor_background_color"),r.get("anchor_border_width"),r.get("block_border_color")),g(i,t,e,15,r.get("action_color"),r.get("block_border_width"),r.get("block_border_color")),i},b3e.draw.conditionShape=function(o,r){var e,t=o._displaySymbol.getBounds(),a=Math.max(t.width+15,o._width),t=Math.max(t.height+15,o._height),i=r.get("anchor_offset_x"),h=o._displayShape;return o._width=a,o._height=t,c(h,-a/2-i,0,r.get("anchor_radius"),r.get("anchor_background_color"),r.get("anchor_border_width"),r.get("block_border_color")),o=h,i=a,a=t,t=r.get("condition_color"),e=r.get("block_border_width"),r=r.get("block_border_color"),o.graphics.beginFill(t),o.graphics.setStrokeStyle(e,"round"),o.graphics.beginStroke(r),o.graphics.drawEllipse(-i/2,-a/2,i,a),o.graphics.endStroke(),o.graphics.endFill(),h},b3e.draw.treeShape=function(o,r){var e=o._displaySymbol.getBounds(),t=Math.max(e.width+15,o._width),e=Math.max(e.height+15,o._height),a=r.get("anchor_offset_x"),i=o._displayShape,o=(o._width=t,o._height=e,0),h=0;return"horizontal"===r.get("layout")?o=t/2+a:h=e/2+a,c(i,-o,-h,r.get("anchor_radius"),r.get("anchor_background_color"),r.get("anchor_border_width"),r.get("block_border_color")),a=i,o=t,h=e,t=r.get("tree_color"),e=r.get("block_border_width"),r=r.get("block_border_color"),a.graphics.beginFill(t),a.graphics.setStrokeStyle(e,"round"),a.graphics.beginStroke(r),a.graphics.moveTo(-o/2,0),a.graphics.lineTo(-o/2+10,-h/2),a.graphics.lineTo(o/2-10,-h/2),a.graphics.lineTo(o/2,0),a.graphics.lineTo(o/2-10,h/2),a.graphics.lineTo(-o/2+10,h/2),a.graphics.lineTo(-o/2,0),a.graphics.endStroke(),a.graphics.endFill(),i},b3e.draw.SHAPES={root:b3e.draw.rootShape,tree:b3e.draw.treeShape,composite:b3e.draw.compositeShape,decorator:b3e.draw.decoratorShape,action:b3e.draw.actionShape,condition:b3e.draw.conditionShape}})();
b3e.draw.rootSymbol=function(e,r){var i=new createjs.Shape,e=(e._width,e._height),o=e/20,e=e/5,r=r.get("block_symbol_color");return i.graphics.setStrokeStyle(o,"round"),i.graphics.beginStroke(r),i.graphics.drawCircle(0,0,e),i.graphics.moveTo(-e,e),i.graphics.lineTo(e,-e),i.graphics.endStroke(),i},b3e.draw.sequenceSymbol=function(e,r){var i=new createjs.Shape,e=(e._width,e._height),o=e/20,e=e/4,r=r.get("block_symbol_color");return i.graphics.setStrokeStyle(o,"round"),i.graphics.beginStroke(r),i.graphics.beginFill(r),i.graphics.moveTo(-e,0),i.graphics.lineTo(e,0),i.graphics.drawPolyStar(e/2,0,e/2,3,0,0),i.graphics.endFill(),i.graphics.endStroke(),i},b3e.draw.memsequenceSymbol=function(e,r){var i=new createjs.Shape,e=(e._width,e._height),o=e/20,e=e/4,r=r.get("block_symbol_color");return i.graphics.setStrokeStyle(o,"round"),i.graphics.beginStroke(r),i.graphics.beginFill(r),i.graphics.drawPolyStar(0,.75*-e,e/2,6,e/10,0),i.graphics.setStrokeStyle(o,"round"),i.graphics.beginStroke(r),i.graphics.beginFill(r),i.graphics.moveTo(-e,e/2),i.graphics.lineTo(e,e/2),i.graphics.drawPolyStar(e/2,e/2,e/2,3,0,0),i.graphics.endFill(),i.graphics.endStroke(),i},b3e.draw.prioritySymbol=function(e,r){var i=new createjs.Shape,e=(e._width,e._height),o=e/20,e=e/8,r=r.get("block_symbol_color");return i.graphics.setStrokeStyle(o,"round"),i.graphics.beginStroke(r),i.graphics.arc(0,-e,e,3.141561,1.570796,!1),i.graphics.lineTo(0,e),i.graphics.beginFill(r),i.graphics.drawCircle(0,2*e,o/2),i.graphics.endFill(),i.graphics.endStroke(),i},b3e.draw.memprioritySymbol=function(e,r){var i=new createjs.Shape,e=(e._width,e._height),o=e/20,e=e/8,r=r.get("block_symbol_color");return i.graphics.setStrokeStyle(o,"round"),i.graphics.beginStroke(r),i.graphics.arc(-e,-e,e,3.141561,1.570796,!1),i.graphics.lineTo(-e,e),i.graphics.beginFill(r),i.graphics.drawCircle(-e,2*e,o/2),i.graphics.drawPolyStar(1.5*e,0,e/2,6,e/10,0),i.graphics.endFill(),i.graphics.endStroke(),i},b3e.draw.textSymbol=function(e,r){e=new createjs.Text(e.getTitle(),"18px Arial",r.get("block_symbol_color")),e.textAlign="center",r=e.getBounds();return e.regY=r.height/2,e},b3e.draw.SYMBOLS={Root:b3e.draw.rootSymbol,Sequence:b3e.draw.sequenceSymbol,Priority:b3e.draw.prioritySymbol,MemSequence:b3e.draw.memsequenceSymbol,MemPriority:b3e.draw.memprioritySymbol};
(()=>{function t(){this.Container_constructor(),this._project=null,this._game=null,this._settings=new b3e.SettingsManager,this._dirty=0,this._systems=[],this.project=null,this.export=null,this.import=null,this.shortcuts=null,this._createGame()}var e=createjs.extend(t,createjs.Container);e._createGame=function(){var t=this;this._game=new tine.Game(null,{update:function(){t._update()}}),this._initialize()},e._initialize=function(){function t(){e._game.canvas.width=window.innerWidth,e._game.canvas.height=window.innerHeight}var e=this;(window.onresize=t)(),this._game.stage.addChild(this),this.project=new b3e.editor.ProjectManager(this),this.export=new b3e.editor.ExportManager(this),this.import=new b3e.editor.ImportManager(this),this.shortcuts=new b3e.editor.ShortcutManager(this),this._systems.push(new b3e.editor.CameraSystem(this)),this._systems.push(new b3e.editor.ConnectionSystem(this)),this._systems.push(new b3e.editor.SelectionSystem(this)),this._systems.push(new b3e.editor.DragSystem(this)),this._systems.push(new b3e.editor.CollapseSystem(this)),this._systems.push(new b3e.editor.ShortcutSystem(this)),this.applySettings("default")},e._update=function(){var e=this._game.time.delta;this._systems.forEach(function(t){t.update(e)})},e.trigger=function(t,e,s){s=s||{};t=new createjs.Event(t);t._target=e,t._data=s,this.dispatchEvent(t)},e.applySettings=function(t){"default"===t&&(t=b3e.DEFAULT_SETTINGS,this._settings.clear()),t&&this._settings.load(t),this._game.canvas.style.backgroundColor=this._settings.get("background_color"),this.project._applySettings(this._settings),this.export._applySettings(this._settings),this.import._applySettings(this._settings),this.shortcuts._applySettings(this._settings)},e.preview=function(t){var e,s=document.createElement("canvas"),i=this.project.get(),t=i.nodes.get(t),i=i.trees.getSelected();if(t)return(t=new b3e.Block(t))._applySettings(this._settings),t.x=t._width,t.y=t._height,s.setAttribute("width",t._width*i.scaleX*2),s.setAttribute("height",t._height*i.scaleY*2),(e=new createjs.Stage(s)).scaleX=i.scaleX,e.scaleY=i.scaleY,e.addChild(t),e.update(),s},e.isDirty=function(){return 0!==this._dirty},e.clearDirty=function(){this._dirty=0},b3e.editor.Editor=createjs.promote(t,"Container")})();
(()=>{function e(e){this.Container_constructor(),this._id=b3.createUUID(),this._editor=e,this._selectedTree=null,this._clipboard=null,this._nodes={},this.trees=null,this.nodes=null,this.history=null,this._initialize()}var t=createjs.extend(e,createjs.Container);t._initialize=function(){this.trees=new b3e.project.TreeManager(this._editor,this),this.nodes=new b3e.project.NodeManager(this._editor,this),this.history=new b3e.project.HistoryManager(this._editor,this),this.nodes.add(b3e.Root,!0),this.nodes.add(b3.Sequence,!0),this.nodes.add(b3.Priority,!0),this.nodes.add(b3.MemSequence,!0),this.nodes.add(b3.MemPriority,!0),this.nodes.add(b3.Repeater,!0),this.nodes.add(b3.RepeatUntilFailure,!0),this.nodes.add(b3.RepeatUntilSuccess,!0),this.nodes.add(b3.MaxTime,!0),this.nodes.add(b3.Inverter,!0),this.nodes.add(b3.Limiter,!0),this.nodes.add(b3.Failer,!0),this.nodes.add(b3.Succeeder,!0),this.nodes.add(b3.Runner,!0),this.nodes.add(b3.Error,!0),this.nodes.add(b3.Wait,!0),this._applySettings(this._editor._settings),this.history.clear(),this._editor.clearDirty()},t._applySettings=function(e){this.trees._applySettings(e),this.nodes._applySettings(e),this.history._applySettings(e)},b3e.project.Project=createjs.promote(e,"Container")})();
(()=>{function t(t,e){this.Container_constructor(),this._id=b3.createUUID(),this._editor=t,this._project=e,this._selectedBlocks=[],this._selectionBox=null,this._root=null,this._blocks=new createjs.Container,this._connections=new createjs.Container,this._overlay=new createjs.Container,this.blocks=null,this.connections=null,this.edit=null,this.selection=null,this.view=null,this.organizer=null,this._initialize()}var e=createjs.extend(t,createjs.Container);e._initialize=function(){this.blocks=new b3e.tree.BlockManager(this._editor,this._project,this),this.connections=new b3e.tree.ConnectionManager(this._editor,this._project,this),this.edit=new b3e.tree.EditManager(this._editor,this._project,this),this.selection=new b3e.tree.SelectionManager(this._editor,this._project,this),this.view=new b3e.tree.ViewManager(this._editor,this._project,this),this.organize=new b3e.tree.OrganizeManager(this._editor,this._project,this),this.addChild(this._connections),this.addChild(this._blocks),this.addChild(this._overlay),this._selectionBox=new b3e.SelectionBox,this._overlay.addChild(this._selectionBox),this._root=this.blocks.add("Root",0,0),this._applySettings(this._editor._settings),this.view.center()},e._applySettings=function(t){this._selectionBox._applySettings(t),this.blocks._applySettings(t),this.connections._applySettings(t),this.edit._applySettings(t),this.selection._applySettings(t),this.view._applySettings(t),this.organize._applySettings(t)},b3e.tree.Tree=createjs.promote(t,"Container")})();
b3e.editor.CameraSystem=function(n){var t=!1,o=0,a=0,s=(this.update=function(e){var s,t,o=n.project.get();o&&(o=o.trees.getSelected())&&(s=n._game.keyboard,t=tine.keys,s.isDown(t.CTRL)?s.isPressed(t.UP)?o.view.zoomIn():s.isPressed(t.DOWN)&&o.view.zoomOut():(s.isDown(t.LEFT)?o.x+=e:s.isDown(t.RIGHT)&&(o.x-=e),s.isDown(t.UP)?o.y+=e:s.isDown(t.DOWN)&&(o.y-=e)))},this.onMouseDown=function(e){var s;2===e.nativeEvent.which&&(e=n.project.get())&&(s=e.trees.getSelected())&&(n._game.canvas.className+=" grabbing",t=!0,o=n._game.mouse.x-s.x,a=n._game.mouse.y-s.y)},this.onMouseMove=function(e){var s;t&&(s=n.project.get())&&(s=s.trees.getSelected())&&(s.x=n._game.mouse.x-o,s.y=n._game.mouse.y-a)},this.onMouseUp=function(e){2===e.nativeEvent.which&&(e=n.project.get())&&e.trees.getSelected()&&(n._game.canvas.className=n._game.canvas.className.replace(/(?:^|\s)grabbing(?!\S)/g,""),t=!1,a=o=0)},this.onMouseWheel=function(e){var s=n.project.get();s&&(s=s.trees.getSelected())&&e.ctrlKey&&(0<(e.wheelDeltaY||e.deltaY)?s.view.zoomIn():s.view.zoomOut())},this);n._game.stage.on("stagemousedown",this.onMouseDown,this),n._game.stage.on("stagemousemove",this.onMouseMove,this),n._game.stage.on("stagemouseup",this.onMouseUp,this),n._game.canvas.addEventListener("wheel",function(e){s.onMouseWheel(e)},!1),n._game.canvas.addEventListener("mousewheel",function(e){s.onMouseWheel(e)},!1),n._game.canvas.addEventListener("DOMMouseScroll ",function(e){s.onMouseWheel(e)},!1)};
b3e.editor.CollapseSystem=function(t){this.update=function(t){}};
b3e.editor.ConnectionSystem=function(c){var s=null,l=null;this.update=function(n){},this.onMouseDown=function(n){var o,e,t,i;1===n.nativeEvent.which&&(n=c.project.get())&&(o=n.trees.getSelected())&&(e=(n=o.view.getLocalPoint()).x,i=o.blocks.getUnderPoint(e,t=n.y),!s)&&i&&(i._hitOutAnchor(e,t)?s=o.connections.add(i,null):i._hitInAnchor(e,t)&&(n=i._inConnection)&&(i._inConnection=null,n._outBlock=null,l=i,s=n))},this.onMouseMove=function(n){var o,e;s&&(o=c.project.get())&&(o=o.trees.getSelected())&&(e=(o=o.view.getLocalPoint()).x,s._redraw(null,null,e,o.y))},this.onMouseUp=function(n){var o,e,t,i;1===n.nativeEvent.which&&s&&(n=c.project.get())&&(o=n.trees.getSelected())&&(e=(t=o.view.getLocalPoint()).x,e=o.blocks.getUnderPoint(e,t.y),n.history._beginBatch(),e&&e!==s._inBlock&&"root"!==e.category?(e._inConnection&&(i=e._inConnection,o.connections.remove(i)),("root"===s._inBlock.category||"decorator"===s._inBlock.category)&&1<s._inBlock._outConnections.length&&(i=s._inBlock._outConnections[0],o.connections.remove(i)),(s._outBlock=e)._inConnection=s,t=[o.connections,o.connections._remove,[e]],i=[o.connections,o.connections.add,[s._inBlock,e]],n.history._add(new b3e.Command(t,i)),s._redraw()):(l&&((l._inConnection=s)._outBlock=l),o.connections.remove(s)),n.history._endBatch(),s=null)},c._game.stage.on("stagemousedown",this.onMouseDown,this),c._game.stage.on("stagemousemove",this.onMouseMove,this),c._game.stage.on("stagemouseup",this.onMouseUp,this)};
b3e.editor.DragSystem=function(f){var _=!1,a=0,r=0;this.update=function(e){},this.onMouseDown=function(e){if(1===e.nativeEvent.which&&!e.nativeEvent.ctrlKey&&!_){e=f.project.get();if(e){var t=e.trees.getSelected();if(t){var e=t.view.getLocalPoint(),o=e.x,s=e.y,n=t.blocks.getUnderPoint(o,s);if(n&&n._isSelected&&n._hitBody(o,s)){_=!0,a=o,r=s;for(var i=0;i<t._selectedBlocks.length;i++)(n=t._selectedBlocks[i])._isDragging=!0,n._dragOffsetX=o-n.x,n._dragOffsetY=s-n.y}}}}},this.onMouseMove=function(e){if(_){var t=f.project.get();if(t){var o=t.trees.getSelected();if(o)for(var t=o.view.getLocalPoint(),s=t.x,n=t.y,i=0;i<o._selectedBlocks.length;i++){var a=o._selectedBlocks[i],r=s-a._dragOffsetX,c=n-a._dragOffsetY;a.x=r,a.y=c,a._snap(),a._inConnection&&a._inConnection._redraw();for(var g=0;g<a._outConnections.length;g++)a._outConnections[g]._redraw()}}}},this.onMouseUp=function(e){if(1===e.nativeEvent.which&&_){var t=f.project.get();if(t){var o=t.trees.getSelected();if(o){_=!1;e=o.view.getLocalPoint();e.x;t.history._beginBatch();for(var s=0;s<o._selectedBlocks.length;s++){var n=o._selectedBlocks[s],i=(n._isDragging=!1,[n,a-n._dragOffsetX,r-n._dragOffsetY]),n=[n,n.x,n.y];if(i[1]===n[1]&&i[2]===n[2])break;t.history._add(new b3e.Command([o.blocks,o.blocks._move,i],[o.blocks,o.blocks._move,n]))}t.history._endBatch()}}}},f._game.stage.on("stagemousedown",this.onMouseDown,this),f._game.stage.on("stagemousemove",this.onMouseMove,this),f._game.stage.on("stagemouseup",this.onMouseUp,this)};
b3e.editor.SelectionSystem=function(l){var n,s,a=!1,h=0,v=0;this.update=function(e){},this.onMouseDown=function(e){var t,o,i=l.project.get();i&&(i=i.trees.getSelected())&&1===e.nativeEvent.which&&(n=e.nativeEvent.ctrlKey,e.nativeEvent.shiftKey,s=e.nativeEvent.altKey,t=(e=i.view.getLocalPoint()).x,(o=i.blocks.getUnderPoint(t,e=e.y))&&o._isSelected&&n?s?i.selection.deselectSubtree(o):i.selection.deselect(o):o&&!o._isSelected&&o._hitBody(t,e)?(n||i.selection.deselectAll(),s?i.selection.selectSubtree(o):i.selection.select(o)):o&&o._hitBody(t,e)?s&&i.selection.selectSubtree(o):o||(a=!0,h=t,v=e,n)||i.selection.deselectAll())},this.onMouseMove=function(e){var t,o,i;a&&(t=l.project.get())&&(t=t.trees.getSelected())&&(o=(i=t.view.getLocalPoint()).x,i=i.y,t._selectionBox.visible=!0,t._selectionBox._redraw(h,v,o,i))},this.onMouseUp=function(e){var t,o,i,n,s,c;1===e.nativeEvent.which&&a&&(e=l.project.get())&&(t=e.trees.getSelected())&&(o=(e=t.view.getLocalPoint()).x,e=e.y,i=Math.min(h,o),n=Math.min(v,e),s=Math.max(h,o),c=Math.max(v,e),t.blocks.each(function(e){e._isContainedIn(i,n,s,c)&&t.selection.select(e)}),t._selectionBox.visible=!1,a=!1)},l._game.stage.on("stagemousedown",this.onMouseDown,this),l._game.stage.on("stagemousemove",this.onMouseMove,this),l._game.stage.on("stagemouseup",this.onMouseUp,this)};
b3e.editor.ShortcutSystem=function(o){this.update=function(e){var t=o.project.get();t&&t.trees.getSelected()&&(o._game.keyboard,tine.keys)}};
b3e.editor.ExportManager=function(n){function s(e){for(var t=e._outConnections.slice(0),o=("horizontal"===n._settings.get("layout")?t.sort(function(e,t){return e._outBlock.y-t._outBlock.y}):t.sort(function(e,t){return e._outBlock.x-t._outBlock.x}),[]),r=0;r<t.length;r++)o.push(t[r]._outBlock.id);return o}this.projectToData=function(){var e,o,t=n.project.get();if(t)return e=t.trees.getSelected(),o={version:b3e.VERSION,scope:"project",selectedTree:e?e._id:null,trees:[],custom_nodes:this.nodesToData()},t.trees.each(function(e){var t=this.treeToData(e,!0);t.id=e._id,o.trees.push(t)},this),o},this.treeToData=function(e,t){var o=n.project.get();if(o){if(e){if(!(e=o.trees.get(e)))return}else e=o.trees.getSelected();var o=e.blocks.getRoot(),r=s(o),i={version:b3e.VERSION,scope:"tree",id:e._id,title:o.title,description:o.description,root:r[0]||null,properties:o.properties,nodes:{},display:{camera_x:e.x,camera_y:e.y,camera_z:e.scaleX,x:o.x,y:o.y}};return t||(i.custom_nodes=this.nodesToData()),e.blocks.each(function(e){var t,o;"root"!==e.category&&(t={id:e.id,name:e.name,title:e.title,description:e.description,properties:e.properties,display:{x:e.x,y:e.y}},o=s(e),"composite"===e.category?t.children=o:"decorator"===e.category&&(t.child=o[0]),i.nodes[e.id]=t)}),i}},this.nodesToData=function(){var t,e=n.project.get();if(e)return t=[],e.nodes.each(function(e){e.isDefault||t.push({version:b3e.VERSION,scope:"node",name:e.name,category:e.category,title:e.title,description:e.description,properties:e.properties})}),t},this.nodesToJavascript=function(){},this._applySettings=function(e){}};
b3e.editor.ImportManager=function(h){this.projectAsData=function(e){var t=h.project.get();t&&(e.custom_nodes&&this.nodesAsData(e.custom_nodes),e.trees&&this.treesAsData(e.trees),e.selectedTree&&t.trees.select(e.selectedTree),h.trigger("projectimported"))},this.treeAsData=function(e){var t=h.project.get();if(t){var r,o=t.trees.add(e.id),s=o.blocks.getRoot(),i=null,a=e.display||{};for(r in o.x=a.camera_x||0,o.y=a.camera_y||0,o.scaleX=a.camera_z||1,o.scaleY=a.camera_z||1,t.nodes.get(o._id).title=e.title,s.title=e.title,s.description=e.description,s.properties=e.properties,s.x=a.x||0,s.y=a.y||0,e.custom_nodes&&this.nodesAsData(e.custom_nodes),e.nodes){var n,d=null;(n=e.nodes[r]).display;(d=o.blocks.add(n.name,n.display.x,n.display.y)).id=n.id,d.title=n.title,d.description=n.description,d.properties=tine.merge({},d.properties,n.properties),d._redraw(),n.id===e.root&&(i=d)}for(r in e.nodes){n=e.nodes[r];var c=o.blocks.get(r),l=null;if("composite"===c.category&&n.children?l=n.children:!n.child||"decorator"!=c.category&&"root"!=c.category||(l=[n.child]),l)for(var p=0;p<l.length;p++){var g=o.blocks.get(l[p]);o.connections.add(c,g)}}i&&o.connections.add(s,i),e.display||o.organize.organize(!0),o.selection.deselectAll(),o.selection.select(s),t.history.clear(),h.trigger("treeimported")}},this.treesAsData=function(e){for(var t=0;t<e.length;t++)this.treeAsData(e[t])},this.nodesAsData=function(e){var t=h.project.get();if(t){for(var r=0;r<e.length;r++)t.nodes.add(e[r]);h.trigger("nodeimported")}},this._applySettings=function(e){}};
b3e.editor.ProjectManager=function(r){this.create=function(){this.close();var e=new b3e.project.Project(r);r.addChild(e),r._project=e,r.trigger("projectcreated",r._project),r._project.trees.add()},this.open=function(e){this.close();var t=new b3e.project.Project(r);r.addChild(t),r._project=t,r.import.projectAsData(e),r.trigger("projectopened",r._project),r.clearDirty()},this.close=function(){var e=r._project;e&&(r.removeChild(e),r.trigger("projectclosed",e))},this.get=function(){return r._project},this._applySettings=function(e){r._project&&r._project._applySettings(e)}};
b3e.editor.ShortcutManager=function(t){this._applySettings=function(t){}};
b3e.project.HistoryManager=function(e,i){var c=[],s=0,o=0,h=0,r=[];this.clear=function(){c=[],s=0},this.undo=function(){this._lock(),this.canUndo()&&(c[--s].undo(),i.trees.select(c[s].context)),this._unlock(),e._dirty--},this.redo=function(){this._lock(),this.canRedo()&&(c[s].redo(),i.trees.select(c[s].context),s++),this._unlock(),e._dirty++},this.canUndo=function(){return 0<s},this.canRedo=function(){return s<c.length},this._add=function(t,n){0<o||(c.length>s&&c.splice(s,c.length-s),0<h?r.push(t):(s++,t.context=i.trees.getSelected(),c.push(t),e._dirty<0&&(e._dirty=0),e._dirty++),t=e._settings.get("max_history"),c.length>t&&c.splice(0,1))},this._lock=function(){o++},this._unlock=function(){o--},this._beginBatch=function(){h++},this._endBatch=function(){var t;0===(h=Math.max(0,h-1))&&(0<r.length&&((t=new b3e.Commands(r)).context=i.trees.getSelected(),this._add(t)),r=[])},this._applySettings=function(t){t=t.get("max_history");c.length>t&&c.splice(0,c.length-t)}};
b3e.project.NodeManager=function(n,r){this.add=function(e,t){var i;return e.prototype&&(e=e.prototype),!r._nodes[e.name]&&(e instanceof b3e.Node||((i=new b3e.Node(t)).name=e.name,i.category=e.category,i.title=e.title,i.description=e.description,i.properties=tine.merge({},e.properties||e.parameters),e=i),r._nodes[e.name]=e,!0!==t&&n.trigger("nodeadded",e),i=[this,this.remove,[e]],t=[this,this.add,[e]],r.history._add(new b3e.Command(i,t)),e)},this.get=function(e){return"string"!=typeof e?e:r._nodes[e]},this.update=function(e,t){var o=(e=this.get(e)).name;if(delete r._nodes[e.name],e.name!==t.name&&this.get(t.name))return!1;var i={name:e.name,title:e.title,description:e.description,category:e.category,properties:e.properties},t=(void 0!==t.name&&(e.name=t.name),void 0!==t.title&&(e.title=t.title),void 0!==t.category&&(e.category=t.category),void 0!==t.description&&(e.description=t.description),void 0!==t.properties&&(e.properties=tine.merge({},t.properties)),{name:e.name,title:e.title,description:e.description,category:e.category,properties:e.properties}),i=(r.history._beginBatch(),r.trees.each(function(e){for(var t=e.blocks.getAll(),i=t.length-1;0<=i;i--)t[i].name===o&&e.blocks.update(t[i])}),r._nodes[e.name]=e,[this,this.update,[e,i]]),t=[this,this.update,[e,t]];r.history._add(new b3e.Command(i,t)),r.history._endBatch(),n.trigger("nodechanged",e)},this.remove=function(e){r.history._beginBatch();var o=e.name||e,t=(delete r._nodes[o],r.trees.each(function(e){for(var t=e.blocks.getAll(),i=t.length-1;0<=i;i--)t[i].name===o&&e.blocks.remove(t[i])}),[this,this.add,[e]]),i=[this,this.remove,[e]];r.history._add(new b3e.Command(t,i)),r.history._endBatch(),n.trigger("noderemoved",e)},this.each=function(t,i){Object.keys(r._nodes).forEach(function(e){t.call(i,r._nodes[e])})},this._applySettings=function(e){}};
b3e.project.TreeManager=function(r,d){this.add=function(e){var t,i;return e instanceof b3e.tree.Tree?(d.addChild(t=e),r.trigger("treeadded",t),this.select(t)):(d.history._beginBatch(),i=(t=new b3e.tree.Tree(r,d)).blocks.getRoot(),d.addChild(t),r.trigger("treeadded",t),e&&(t._id=e),e={name:t._id,title:i.title,category:"tree"},d.nodes.add(e,!0),this.select(t),i=[this,this.remove,[t]],e=[this,this.add,[t]],d.history._add(new b3e.Command(i,e)),d.history._endBatch()),t},this.get=function(e){if("string"!=typeof e)return e;for(var t=0;t<d.children.length;t++)if(d.children[t]._id===e)return d.children[t]},this.getSelected=function(){return d._selectedTree},this.select=function(e){!(e=this.get(e))||d.getChildIndex(e)<0||d._selectedTree!==e&&(d._selectedTree&&(d._selectedTree.visible=!1,r.trigger("treedeselected",d._selectedTree)),e.visible=!0,d._selectedTree=e,r.trigger("treeselected",e))},this.remove=function(e){d.history._beginBatch(),e=this.get(e);var t=d.children.indexOf(e),t=(d.removeChild(e),d.nodes.remove(e._id),r.trigger("treeremoved",e),0===d.children.length?this.add():e===d._selectedTree&&this.select(0===t?d.children[t]:d.children[t-1]),[this,this.add,[e]]),e=[this,this.remove,[e]];d.history._add(new b3e.Command(t,e)),d.history._endBatch()},this.each=function(e,t){d.children.forEach(e,t)},this._applySettings=function(t){this.each(function(e){e._applySettings(t)})}};
b3e.tree.BlockManager=function(c,d,h){this._move=function(e,t,n){e.x=t,e.y=n,e._redraw(),e._inConnection&&e._inConnection._redraw();for(var i=0;i<e._outConnections.length;i++)e._outConnections[i]._redraw()},this.add=function(e,t,n){e instanceof b3e.Block?((i=e)._snap(),h._blocks.addChild(i)):(t=t||0,n=n||0,"string"==typeof(o=e)&&(o=d.nodes.get(e)),(i=new b3e.Block(o))._applySettings(c._settings),i.x=t,i.y=n,i._snap(),h._blocks.addChild(i),h.selection.deselectAll(),h.selection.select(i)),c.trigger("blockadded",i);var i,e=[this,this.remove,[i]],o=[this,this.add,[i,i.x,i.y]];return d.history._add(new b3e.Command(e,o)),i},this.get=function(e){if("string"!=typeof e)return e;for(var t=h._blocks.children,n=0;n<t.length;n++)if(t[n].id===e)return t[n]},this.getUnderPoint=function(e,t){e&&t||(e=(n=h.view.getLocalPoint()).x,t=n.y);for(var n,i=this.getAll(),o=i.length-1;0<=o;o--){var r=i[o];if(r._hitTest(e,t))return r}},this.getSelected=function(){return h._selectedBlocks.slice()},this.getAll=function(){return h._blocks.children},this.getRoot=function(){return h._root},this.update=function(e,t,n){var i=!!t,o={name:e.name,title:e.title,description:e.description,properties:e.properties},r=e.node,t=(void 0!==(t=t||{}).name?e.name=t.name:e.name=r.name||e.name,e.title=void 0!==t.title?t.title:r.title||e.title,e.description=void 0!==t.description?t.description:r.description||e.description,e.properties=void 0!==t.properties?tine.merge({},r.properties,t.properties):tine.merge({},r.properties,e.properties),e._redraw(),{name:e.name,title:e.title,description:e.description,properties:e.properties});e._inConnection&&e._inConnection._redraw();for(var s=0;s<e._outConnections.length;s++)e._outConnections[s]._redraw();i||d.history._lock(),d.history._beginBatch(),"root"===e.category&&d.nodes.update(h._id,{title:e.title||"A behavior tree"});r=[this,this.update,[e,o]],o=[this,this.update,[e,t]];d.history._add(new b3e.Command(r,o)),d.history._endBatch(),i||d.history._unlock(),c.trigger("blockchanged",e)},this.remove=function(e){if(d.history._beginBatch(),h._blocks.removeChild(e),e._inConnection&&h.connections.remove(e._inConnection),0<e._outConnections.length)for(var t=e._outConnections.length-1;0<=t;t--)h.connections.remove(e._outConnections[t]);e._isSelected&&h.selection.deselect(e);var n=[this,this.add,[e,e.x,e.y]],i=[this,this.remove,[e]];d.history._add(new b3e.Command(n,i)),d.history._endBatch(),c.trigger("blockremoved",e)},this.cut=function(e){if(d.history._beginBatch(),h._blocks.removeChild(e),e._inConnection&&(e._inConnection._outBlock._isSelected?e._inConnection.visible=!1:h.connections.remove(e._inConnection)),0<e._outConnections.length)for(var t=e._outConnections.length-1;0<=t;t--)e._outConnections[t]._inBlock._isSelected?e._outConnections[t].visible=!1:h.connections.remove(e._outConnections[t]);var n=[this,this.add,[e,e.x,e.y]],i=[this,this.remove,[e]];d.history._add(new b3e.Command(n,i)),c.trigger("blockremoved",e),d.history._endBatch()},this.each=function(e,t){h._blocks.children.forEach(e,t)},this._applySettings=function(t){this.each(function(e){e._applySettings(t)})}};
b3e.tree.ConnectionManager=function(e,c,_){this._remove=function(n){c.history._lock(),this.remove(n._inConnection),c.history._unlock()},this.add=function(n,o){var t,i=new b3e.Connection;return n&&((i._inBlock=n)._outConnections.push(i),e.trigger("blockconnected",n,{connection:i,type:"outConnection",other:o})),o&&((i._outBlock=o)._inConnection=i,e.trigger("blockconnected",o,{connection:i,type:"inConnection",other:n})),n&&o&&(t=[this,this._remove,[o]],n=[this,this.add,[n,o]],c.history._add(new b3e.Command(t,n))),i._applySettings(e._settings),_._connections.addChild(i),i},this.remove=function(n){var o,t;n._inBlock&&n._outBlock&&(o=[this,this.add,[n._inBlock,n._outBlock]],t=[this,this._remove,[n._outBlock]],c.history._add(new b3e.Command(o,t))),n._inBlock&&(n._inBlock._outConnections.remove(n),n._inBlock=null),n._outBlock&&(n._outBlock._inConnection=null,n._outBlock=null),_._connections.removeChild(n),e.trigger("connectionremoved",n)},this.each=function(n,o){_._connections.children.forEach(n,o)},this._applySettings=function(o){this.each(function(n){n._applySettings(o)})}};
b3e.tree.EditManager=function(o,r,_){this._selectionToClipboard=function(){for(var o,e,t,n,c={blocks:{},connections:[]},i=_._selectedBlocks,s=0;s<i.length;s++)"root"!==(n=i[s]).category&&((t={}).id=n.id,t.node=n.node,t.name=n.name,t.title=n.title,t.category=n.category,t.description=n.description,t.properties=n.properties,t._settings=n._settings,t.x=n.x,t.y=n.y,c.blocks[n.id]=t);for(s=0;s<i.length;s++)if("root"!==(n=i[s]).category)for(o=0;o<n._outConnections.length;o++)e=n._outConnections[o]._outBlock,c.blocks[e.id]&&c.connections.push([n.id,e.id]);r._clipboard=c},this.copy=function(){this._selectionToClipboard()},this.cut=function(){this._selectionToClipboard(),r.history._beginBatch();for(var o=_._selectedBlocks.length-1;0<=o;o--)"root"!=_._selectedBlocks[o].category&&_.blocks.remove(_._selectedBlocks[o]);r.history._endBatch(),_._selectedBlocks=[],console.log(r._clipboard)},this.paste=function(){if(null!==r._clipboard){var o,e,t={},n=[];for(e in r.history._beginBatch(),r._clipboard.blocks){var c=r._clipboard.blocks[e],i=new b3e.Block(c);c.x+=50,c.y+=50,i._applySettings(c._settings),i.x=c.x,i.y=c.y,_.blocks.add(i),n.push(t[e]=i)}for(o=0;o<r._clipboard.connections.length;o++){var s=r._clipboard.connections[o],l=t[s[0]];_.connections.add(l,t[s[1]])}for(_.selection.deselectAll(),o=0;o<n.length;o++)_.selection.select(n[o]);r.history._endBatch()}},this.duplicate=function(){r.history._beginBatch();var o=r._clipboard;this.copy(),this.paste(),r._clipboard=o,r.history._endBatch()},this.remove=function(){r.history._beginBatch();for(var o=_._selectedBlocks.length-1;0<=o;o--)"root"===_._selectedBlocks[o].category?_._selectedBlocks[o]:_.blocks.remove(_._selectedBlocks[o]);r.history._endBatch()},this.removeConnections=function(){r.history._beginBatch();for(var o=0;o<_._selectedBlocks.length;o++){var e=_._selectedBlocks[o];if(e._inConnection&&_.connections.remove(e._inConnection),0<e._outConnections.length)for(var t=e._outConnections.length-1;0<=t;t--)_.connections.remove(e._outConnections[t])}r.history._endBatch()},this.removeInConnections=function(){r.history._beginBatch();for(var o=0;o<_._selectedBlocks.length;o++){var e=_._selectedBlocks[o];e._inConnection&&_.connections.remove(e._inConnection)}r.history._endBatch()},this.removeOutConnections=function(){r.history._beginBatch();for(var o=0;o<_._selectedBlocks.length;o++){var e=_._selectedBlocks[o];if(0<e._outConnections.length)for(var t=e._outConnections.length-1;0<=t;t--)_.connections.remove(e._outConnections[t])}r.history._endBatch()},this._applySettings=function(o){}};
b3e.tree.OrganizeManager=function(l,a,h){var n=null,_=0,g=0,f=!1,y=[],v=[];this.organize=function(o,n){o=o||h.blocks.getRoot(),g=_=0,y=[],v=[];var t,e=o.x,r=o.y,s=[];for(o.traversal(function(o){s.push([o,o.x,o.y])}),("horizontal"===l._settings.get("layout")?function o(n){var t,e;if(v.push(n),0===n._outConnections.length)t=208*_,e=88*++g;else{var r,s=0;f?r=n._outConnections:(r=n._outConnections.slice(0)).sort(function(o,n){return o._outBlock.y-n._outBlock.y});for(var u=0;u<r.length;u++)_++,y.push(r[u]),s+=o(r[u]._outBlock),_--;t=208*_,e=s/n._outConnections.length}return n.x=t,n.y=e}:function o(n){var t,e;if(v.push(n),0===n._outConnections.length)t=208*++g;else{var r,s=0;f?r=n._outConnections:(r=n._outConnections.slice(0)).sort(function(o,n){return o._outBlock.x-n._outBlock.x});for(var u=0;u<r.length;u++)_++,y.push(r[u]),s+=o(r[u]._outBlock),_--;t=s/n._outConnections.length}return e=130*_,n.x=t,n.y=e,t})(o),e-=o.x,r-=o.y,t=0;t<v.length;t++)v[t].x+=e,v[t].y+=r,v[t]._snap();for(t=0;t<y.length;t++)y[t]._redraw();var u=[];for(o.traversal(function(o){u.push([o,o.x,o.y])}),a.history._beginBatch(),t=0;t<v.length;t++){var i=[h.blocks,h.blocks._move,s[t]],c=[h.blocks,h.blocks._move,u[t]];a.history._add(new b3e.Command(i,c))}a.history._endBatch()},this._applySettings=function(o){o=o.get("layout");n&&o!==n&&this.organize(),n=o}};
b3e.tree.SelectionManager=function(t,e,c){this.select=function(e){e._isSelected||(e._select(),c._selectedBlocks.push(e),t.trigger("blockselected",e))},this.deselect=function(e){e._isSelected&&(e._deselect(),c._selectedBlocks.remove(e),t.trigger("blockdeselected",e))},this.selectAll=function(){c.blocks.each(function(e){this.select(e)},this)},this.deselectAll=function(){for(var e=c._selectedBlocks.length-1;0<=e;e--)this.deselect(c._selectedBlocks[e])},this.invertSelection=function(e){(e?[e]:c.blocks.getAll()).forEach(function(e){e._isSelected?this.deselect(e):this.select(e)},this)},this.selectSubtree=function(e){for(var t=e?[e]:c._selectedBlocks,s=function(e){t.remove(e),this.select(e)};0<t.length;)t.pop().traversal(s,this)},this.deselectSubtree=function(e){for(var t=e?[e]:c._selectedBlocks,s=function(e){t.remove(e),this.deselect(e)};0<t.length;)t.pop().traversal(s,this)},this._applySettings=function(e){}};
b3e.tree.ViewManager=function(s,t,n){this.reset=function(){n.x=0,n.y=0,n.scaleX=1,n.scaleY=1},this.zoom=function(t){n.scaleX=t,n.scaleY=t},this.zoomIn=function(){var t=s._settings.get("zoom_min"),e=s._settings.get("zoom_max"),i=s._settings.get("zoom_step"),o=n.scaleX;this.zoom(tine.clip(o+i,t,e))},this.zoomOut=function(){var t=s._settings.get("zoom_min"),e=s._settings.get("zoom_max"),i=s._settings.get("zoom_step"),o=n.scaleX;this.zoom(tine.clip(o-i,t,e))},this.pan=function(t,e){n.x+=t,n.y+=e},this.setCam=function(t,e){n.x=t,n.y=e},this.center=function(){var t=s._game.canvas,e=t.width/2;this.setCam(e,t.height/2)},this.getLocalPoint=function(t,e){return void 0===t&&(t=s._game.mouse.x),void 0===e&&(e=s._game.mouse.y),n.globalToLocal(t,e)},this._applySettings=function(t){}};
angular.module("app",["ui.router","ui.bootstrap","ngAnimate","templates"]).run(["$rootScope","$window","$state",function(e,t,n){e.isDesktop=!!t.process&&!!t.require,e.go=function(e,t){n.go(e,t)}}]).run(["$window","$animate","$location","$document","$timeout","settingsModel","projectModel",function(e,n,t,o,a,i,r){t.path("/"),angular.element(e.editor._game.canvas).attr("b3-drop-node",!0),i.getSettings(),r.getRecentProjects().then(function(e){function t(){a(function(){var e=angular.element(document.getElementById("page-preload"));n.addClass(e,"preload-fade").then(function(){e.remove()})},500)}0<e.length&&e[0].isOpen?r.openProject(e[0].path).then(function(){t()}):t()})}]);
angular.module("app").config(["$stateProvider","$urlRouterProvider",function(t,e){e.otherwise("/dash/home"),t.state("dash",{url:"/dash",abstract:!0,templateUrl:"pages/dash/dash.html",controller:"DashController",controllerAs:"dash"}).state("dash.home",{url:"/home",templateUrl:"pages/home/home.html",controller:"HomeController",controllerAs:"home"}).state("dash.projects",{url:"/projects",templateUrl:"pages/projects/projects.html",controller:"ProjectsController",controllerAs:"projects"}).state("dash.settings",{url:"/settings",templateUrl:"pages/settings/settings.html",controller:"SettingsController",controllerAs:"settings"}).state("editor",{url:"/editor",templateUrl:"pages/editor/editor.html",controller:"EditorController",controllerAs:"editor"}).state("editor.editnode",{url:"/node/:name",templateUrl:"pages/editor/modals/editnode.html",controller:"EditNodeController",controllerAs:"editnode"}).state("editor.export",{url:"/export/:type/:format",templateUrl:"pages/editor/modals/export.html",controller:"ExportController",controllerAs:"export"}).state("editor.import",{url:"/import/:type/:format",templateUrl:"pages/editor/modals/import.html",controller:"ImportController",controllerAs:"import"})}]);
(()=>{function o(o,e,n){window.onbeforeunload=r;try{var i=require("nw.gui").Window.get();i.on("close",function(){var o=i;e.editor.isDirty()?n.confirm("Leave without saving?","If you proceed you will lose all unsaved modifications.",null).then(function(){o.close(!0)}):o.close(!0)})}catch(o){}function r(){if(e.editor.isDirty())return"Leaving now will erase your unsaved changes."}}angular.module("app").controller("AppController",o),o.$inject=["$scope","$window","dialogService"]})();
(()=>{function n(t,o,e,r,i,n){var u=this;function c(n){return t.$$phase?l():t.$apply(function(){l()}),!1}function s(n){return t.$$phase?p():t.$apply(function(){p()}),!1}function d(){return o.editor.project.get()}function a(){return o.editor.project.get().trees.getSelected()}function l(){function n(){i.closeProject(),e.go("dash.projects")}return o.editor.isDirty()?r.confirm("Leave without saving?","If you proceed you will lose all unsaved modifications.",null).then(n):n(),!1}function p(){return i.saveProject().then(function(){n.success("Project saved","The project has been saved")},function(){n.error("Error","Project couldn't be saved")}),!1}function f(){return d().history.undo(),!1}function b(){return d().history.redo(),!1}function M(){return a().edit.copy(),!1}function m(){return a().edit.cut(),!1}function v(){return a().edit.paste(),!1}function j(){return a().edit.duplicate(),!1}function g(){return a().edit.remove(),!1}function y(){return a().organize.organize(),!1}function h(){return a().selection.selectAll(),!1}function $(){return a().selection.deselectAll(),!1}function C(){return a().selection.invertSelection(),!1}u.onNewTree=function(){return d().trees.add(),!1},u.onCloseProject=l,u.onSaveProject=p,u.onExportProjectJson=function(){return e.go("editor.export",{type:"project",format:"json"}),!1},u.onExportTreeJson=function(){return e.go("editor.export",{type:"tree",format:"json"}),!1},u.onExportNodesJson=function(){return e.go("editor.export",{type:"nodes",format:"json"}),!1},u.onImportProjectJson=function(){return e.go("editor.import",{type:"project",format:"json"}),!1},u.onImportTreeJson=function(){return e.go("editor.import",{type:"tree",format:"json"}),!1},u.onImportNodesJson=function(){return e.go("editor.import",{type:"nodes",format:"json"}),!1},u.onUndo=f,u.onRedo=b,u.onCopy=M,u.onCut=m,u.onPaste=v,u.onDuplicate=j,u.onRemove=g,u.onRemoveAllConns=function(){return a().edit.removeConnections(),!1},u.onRemoveInConns=function(){return a().edit.removeInConnections(),!1},u.onRemoveOutConns=function(){return a().edit.removeOutConnections(),!1},u.onAutoOrganize=y,u.onZoomIn=function(){return a().view.zoomIn(),!1},u.onZoomOut=function(){return a().view.zoomOut(),!1},u.onSelectAll=h,u.onDeselectAll=$,u.onInvertSelection=C,Mousetrap.bind("ctrl+q",c),Mousetrap.bind("ctrl+s",s),Mousetrap.bind("ctrl+z",f),Mousetrap.bind("ctrl+shift+z",b),Mousetrap.bind("ctrl+c",M),Mousetrap.bind("ctrl+v",v),Mousetrap.bind("ctrl+x",m),Mousetrap.bind("ctrl+d",j),Mousetrap.bind("del",g),Mousetrap.bind("a",y),Mousetrap.bind("ctrl+a",h),Mousetrap.bind("ctrl+shift+a",$),Mousetrap.bind("ctrl+i",C),t.$on("$destroy",function(){Mousetrap.unbind("ctrl+q",c),Mousetrap.unbind("ctrl+s",s),Mousetrap.unbind("ctrl+z",f),Mousetrap.unbind("ctrl+shift+z",b),Mousetrap.unbind("ctrl+c",M),Mousetrap.unbind("ctrl+v",v),Mousetrap.unbind("ctrl+x",m),Mousetrap.unbind("ctrl+d",j),Mousetrap.unbind("del",g),Mousetrap.unbind("a",y),Mousetrap.unbind("ctrl+a",h),Mousetrap.unbind("ctrl+shift+a",$),Mousetrap.unbind("ctrl+i",C)})}angular.module("app").controller("MenubarController",n),n.$inject=["$scope","$window","$state","dialogService","projectModel","notificationService"]})();
(()=>{function e(o,r,t,n){var d=this;function i(){d.trees=[],d.nodes={composite:[],decorator:[],action:[],condition:[]};var e=r.editor.project.get(),t=(e.nodes.each(function(e){var o;"tree"!==e.category&&(o=d.nodes[e.category])&&o.push({name:e.name,title:(e=>e=(e=e.title||e.name).replace(/(<\w+>)/g,function(e,o){return"@"}))(e),isDefault:e.isDefault})}),e.trees.getSelected());e.trees.each(function(e){var o=e.blocks.getRoot();d.trees.push({id:e._id,name:o.title||"A behavior tree",active:e===t})})}function e(e){setTimeout(function(){o.$apply(function(){i()})},0)}d.nodes=null,d.newTree=function(){r.editor.project.get().trees.add()},d.select=function(e){r.editor.project.get().trees.select(e)},d.remove=function(e){t.confirm("Remove tree?","Are you sure you want to remove this tree?\n\nNote: all blocks using this tree will be removed.").then(function(){r.editor.project.get().trees.remove(e),n.success("Tree removed","The tree has been removed from this project.")})},r.editor.on("nodechanged",e),r.editor.on("noderemoved",e),r.editor.on("nodeadded",e),r.editor.on("treeadded",e),r.editor.on("blockchanged",e),r.editor.on("treeselected",e),r.editor.on("treeremoved",e),r.editor.on("treeimported",e),i(),o.$on("$destroy",function(){r.editor.off("nodechanged",e),r.editor.off("noderemoved",e),r.editor.off("nodeadded",e),r.editor.off("treeadded",e),r.editor.off("blockchanged",e),r.editor.off("treeselected",e),r.editor.off("treeremoved",e),r.editor.off("treeimported",e)})}angular.module("app").controller("NodespanelController",e),e.$inject=["$scope","$window","dialogService","notificationService"]})();
(()=>{function e(o,t){var i=this;function n(){var e=t.editor.project.get().trees.getSelected().blocks.getSelected();1===e.length?(i.original=e[0],i.block={title:i.original.title,description:i.original.description,properties:tine.merge({},i.original.properties)}):(i.original=!1,i.block=!1)}function e(e){setTimeout(function(){o.$apply(function(){n()})},0)}i.original=null,i.block=null,i.update=function(){t.editor.project.get().trees.getSelected().blocks.update(i.original,i.block)},i.keydown=function(e){e.ctrlKey&&90==e.keyCode&&e.preventDefault();return!1},t.editor.on("blockselected",e),t.editor.on("blockdeselected",e),t.editor.on("blockremoved",e),t.editor.on("treeselected",e),t.editor.on("nodechanged",e),n(),o.$on("$destroy",function(){t.editor.off("blockselected",e),t.editor.off("blockdeselected",e),t.editor.off("blockremoved",e),t.editor.off("treeselected",e),t.editor.off("nodechanged",e)})}angular.module("app").controller("PropertiespanelController",e),e.$inject=["$scope","$window"]})();
(()=>{function e(t,r,o,i){var n=this;function c(){n.trees=[];var e=r.editor.project.get(),o=e.trees.getSelected();e.trees.each(function(e){var t=e.blocks.getRoot();n.trees.push({id:e._id,name:t.title||"A behavior tree",active:e===o})})}function e(e){"blockchanged"===e.type&&"root"!==e._target.category||(t.$$phase?c():t.$apply(function(){c()}))}n.trees=null,n.newTree=function(){r.editor.project.get().trees.add()},n.select=function(e){r.editor.project.get().trees.select(e),setTimeout(function(){t.$$phase?c():t.$apply(function(){c()}),r.editor.trigger("treeselected"),r.editor._game&&r.editor._game.update()},10)},n.remove=function(e){o.confirm("Remove tree?","Are you sure you want to remove this tree?\n\nNote: all blocks using this tree will be removed.").then(function(){r.editor.project.get().trees.remove(e),i.success("Tree removed","The tree has been removed from this project.")})},r.editor.on("blockchanged",e),r.editor.on("treeselected",e),r.editor.on("treeremoved",e),r.editor.on("treeimported",e),c(),t.$on("$destroy",function(){r.editor.off("blockchanged",e),r.editor.off("treeselected",e),r.editor.off("treeremoved",e),r.editor.off("treeimported",e)})}angular.module("app").controller("TreespanelController",e),e.$inject=["$scope","$window","dialogService","notificationService"]})();
(()=>{function e(e,o,n,t,i,a){var d=this;d.action="New",d.node=null,d.blacklist=null,d.original=null,d.save=function(){var e=o.editor.project.get();d.original?e.nodes.update(d.original,d.node):e.nodes.add(d.node);n.go("editor"),a.success("Node created","Node has been created successfully.")},d.remove=function(){i.confirm("Remove node?","Are you sure you want to remove this node?\n\nNote: all blocks using this node will be removed.").then(function(){o.editor.project.get().nodes.remove(d.original),a.success("Node removed","The node has been removed from this project."),n.go("editor")})};var r=o.editor.project.get(),c=(t.name&&"new"!==t.name?(t=r.nodes.get(t.name),d.node=t.copy(),d.original=t,d.action="Update"):(d.node=new b3e.Node,d.node.category="composite"),[]);r.nodes.each(function(e){e.name!==d.node.name&&c.push(e.name)}),d.blacklist=c.join(",")}angular.module("app").controller("EditNodeController",e),e.$inject=["$scope","$window","$state","$stateParams","dialogService","notificationService"]})();
(()=>{function t(t,o,n,e,a,r,s){var c=this;function l(t){c.data=t,c.compact=JSON3.stringify(t),c.pretty=JSON3.stringify(t,null,2),c.result=c.pretty}c.type=null,c.format=null,c.compact="",c.pretty="",c.result=null,c.data=null,c.hideCompact=!1,c.showCompact=function(){c.result=c.compact},c.showPretty=function(){c.result=c.pretty},c.select=function(){var t=o[0].createRange(),e=(t.selectNodeContents(o[0].getElementById("export-result")),n.getSelection());e.removeAllRanges(),e.addRange(t)},c.save=function(){a.saveAs(null,[".b3",".json"]).then(function(t){s.saveAsync(t,c.pretty).then(function(){r.success("File saved","The file has been saved successfully.")})})},c.type=e.type,c.format=e.format,e=n.editor.export,"project"===c.type&&"json"===c.format?l(e.projectToData()):"tree"===c.type&&"json"===c.format?l(e.treeToData()):"nodes"===c.type&&"json"===c.format&&l(e.nodesToData())}angular.module("app").controller("ExportController",t),t.$inject=["$scope","$document","$window","$stateParams","dialogService","notificationService","storageService"]})();
(()=>{function t(t,a,e,o,n,r,i){var l=this;l.type=null,l.format=null,l.open=function(){var t=a.editor.import,o=JSON3.parse(l.data);try{"project"===l.type&&"json"===l.format?t.projectAsData(o):"tree"===l.type&&"json"===l.format?t.treeAsData(o):"nodes"===l.type&&"json"===l.format&&t.nodesAsData(o)}catch(t){r.error("Invalid data","The provided data is invalid.")}e.go("editor")},l.loadFromFile=function(){n.openFile(!1,[".b3",".json"]).then(function(t){i.loadAsync(t).then(function(t){l.data=JSON3.stringify(t,null,2)})})},l.data="",l.type=o.type,l.format=o.format}angular.module("app").controller("ImportController",t),t.$inject=["$scope","$window","$state","$stateParams","dialogService","notificationService","storageService"]})();
(()=>{function a(n){return{restrict:"A",link:function(t,a,r){a[0].draggable=!0,a.on("mousedown",function(a){t.nodeToDrag=r.name}),a.on("dragstart",function(a){if(a.dataTransfer)try{a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("text/plain",r.name);try{a.dataTransfer.setData("name",r.name)}catch(a){}try{a.dataTransfer.setData("text",r.name)}catch(a){}try{a.dataTransfer.setData("application/x-behavior3",r.name)}catch(a){}n._currentDragNode=r.name;var e=n.editor.preview(r.name);if(e)try{a.dataTransfer.setDragImage(e,e.width/2,e.height/2)}catch(a){}}catch(a){console.warn("使用备用拖拽方式"),n._currentDragNode=r.name}else{console.warn("使用替代方法传递拖拽数据"),n._currentDragNode=t.nodeToDrag||r.name;e=n.editor.preview(r.name);if(e&&a.dataTransfer)try{a.dataTransfer.setDragImage(e,e.width/2,e.height/2)}catch(a){}}})}}}angular.module("app").directive("b3DragNode",a),a.$inject=["$window"]})();
(()=>{function e(r){return{restrict:"A",link:function(e,t,a){t.bind("dragover",function(e){return e.preventDefault&&e.preventDefault(),!1}),t.bind("drop",function(e){var t,a;e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation();try{e.dataTransfer&&(t=e.dataTransfer.getData("name")||e.dataTransfer.getData("text/plain")||e.dataTransfer.getData("text")||e.dataTransfer.getData("application/x-behavior3"))}catch(e){}!t&&r._currentDragNode&&(t=r._currentDragNode,r._currentDragNode=null),t?(e=(a=r.editor.project.get().trees.getSelected()).view.getLocalPoint(e.clientX,e.clientY),a.blocks.add(t,e.x,e.y),r.editor._game.canvas.focus()):console.warn("未能获取拖放的节点名称")})}}}angular.module("app").directive("b3DropNode",e),e.$inject=["$window"]})();
(()=>{function e(n){return{require:"^ngModel",restrict:"EA",replace:!0,bindToController:!0,controller:"KeyTableController",controllerAs:"keytable",templateUrl:"directives/keytable.html",link:function(o,e,l){o.keytable.heading=l.heading,o.keytable._onChange=n(l.ngChange);l=l.ngModel;o.$watch(l,function(e){o.keytable.reset(e)})}}}function o(r){var t=this;function o(){if(t.model)for(var e in t.model)l(e,t.model[e],!1);else t.model={}}function l(e,o,l){t.rows.push({key:e,value:o,fixed:!0===l})}t._onChange=null,t.model=r.keytable.model||r.model||null,t.rows=[],t.add=l,t.remove=function(e){t.rows.splice(e,1)},t.change=function(){for(var e in t.model)t.model.hasOwnProperty(e)&&delete t.model[e];for(var o=0;o<t.rows.length;o++){var l,n=t.rows[o];n.key&&(l=n.value,isNaN(l)||""===l||(l=parseFloat(l)),t.model[n.key]=l,t._onChange)&&t._onChange(r)}},t.reset=function(e){t.rows=[],t.model=e,o()},o()}angular.module("app").directive("b3KeyTable",e).controller("KeyTableController",o),e.$inject=["$parse"],o.$inject=["$scope"]})();
angular.module("app").directive("b3Tab",function(){return{require:"^b3Tabset",restrict:"EA",scope:{active:"=?",heading:"@"},transclude:!0,templateUrl:"directives/tab.html",link:function(e,t,a,i){e.active=!!e.active,i.add(e)}}});
(()=>{function t(){var a=this;a.tabs=[],a.add=function(t){a.tabs.push(t)},a.select=function(e){angular.forEach(a.tabs,function(t){t.active&&t!==e&&(t.active=!1)}),e.active=!0}}angular.module("app").directive("b3Tabset",function(){return{restrict:"EA",transclude:!0,replace:!0,scope:{},templateUrl:"directives/tabset.html",bindToController:!0,controllerAs:"tabset",controller:t}})})();
(()=>{function t(t,e,r,o,n,c,a){var i=n.join(n.getDataPath(),"recents.json"),u=null,f=null;return{getRecentProjects:function(){return t(function(t,e){if(!u){var n;try{n=o.load(i)}catch(t){}u=n=n||[]}t(u)})},newProject:function(r,o){return t(function(t,e){var n={name:o,description:"",data:[],path:r};a.newProject(),n.data=a.exportProject(),d(n).then(function(){s(n),t()})})},getProject:function(){return f},saveProject:d,openProject:function(r){return t(function(t,e){try{var n=o.load(r);a.openProject(n.data),s(n),t()}catch(t){e(t)}})},closeProject:function(){return t(function(t,e){r.editor.clearDirty(),a.closeProject(),s(null),t()})},removeProject:function(r){return t(function(t,e){for(var n=0;n<u.length;n++)if(u[n].path===r){u.splice(n,1);break}p(),t()})}};function p(){o.save(i,u)}function l(t){if(t){for(var e=u.length-1;0<=e;e--)u[e].path===t.path?u.splice(e,1):u[e].isOpen=!1;var n={name:t.name,description:t.description,path:t.path,isOpen:!0};u.splice(0,0,n)}else for(var r=0;r<u.length;r++)u[r].isOpen=!1;p()}function s(t){l(f=t),e.$broadcast("dash-projectchanged")}function d(n){return(n=n||f).data=a.exportProject(),t(function(t,e){r.editor.clearDirty(),o.save(n.path,n),l(n),t()})}}angular.module("app").factory("projectModel",t),t.$inject=["$q","$rootScope","$window","storageService","systemService","localStorageService","editorService"]})();
(()=>{function t(t,a,e,r){var s=e.join(e.getDataPath(),"settings.json"),g=null;return{getSettings:function(){return t(function(t,e){if(!g){var n,i=r.getDefaultSettings();try{n=a.load(s),r.applySettings(n)}catch(t){}n||a.save(s,n=i),g=tine.merge({},i,n)}t(g)})},saveSettings:function(n){return t(function(t,e){r.applySettings(n),a.save(s,n),g=n,t()})},resetSettings:function(){return t(function(t,e){var n=r.getDefaultSettings();a.save(s,n),g=n,r.applySettings(n),t()})}}}angular.module("app").factory("settingsModel",t),t.$inject=["$q","storageService","systemService","editorService"]})();
function dialogService(i,l,e,r){return{alert:function(e,n,t,o){return(o=o||{}).title=e,o.text=n,o.type=t,o.customClass=t,l(function(e){swal(o,function(){e()})})},confirm:function(e,n,t,o){return(o=o||{}).title=e,o.text=n,o.type=t,o.customClass=t,o.showCancelButton=!0,l(function(n,t){i.swal(o,function(e){(e?n:t)()})})},prompt:function(e,n,t,o,i){return(i=i||{}).title=e,i.text=n,i.type=t||"input",i.inputPlaceholder=o,i.customClass=t,i.showCancelButton=!0,l(function(n,t){swal(i,function(e){(!1!==e?n:t)(e)})})},saveAs:function(o,e){return l(function(e,n){var t=r.dialog.showSaveDialog({title:"Save project as...",defaultPath:o+".b3",filters:[{name:"Behavior3 File",extensions:["b3","json"]},{name:"All Files",extensions:["*"]}]});t?e(t):n()})},openFile:function(o,e){return l(function(e,n){var t=r.dialog.showOpenDialog({title:"Open file...",multiSelections:o,properties:["openFile"],filters:[{name:"Behavior3 File",extensions:["b3","json"]},{name:"All Files",extensions:["*"]}]});t?(o||(t=t[0]),console.log(t),e(t)):n()})},openDirectory:function(){return l(function(e,n){var t=r.dialog.showOpenDialog({title:"Open directory...",properties:["openDirectory"]});t?e(t):n()})}}}angular.module("app").factory("dialogService",dialogService),dialogService.$inject=["$window","$q","$document","nodejsService"];
function editorService(t){return{getDefaultSettings:function(){return t.b3e.DEFAULT_SETTINGS},applySettings:function(e){t.editor.applySettings(e)},newProject:function(){t.editor.project.create()},openProject:function(e){t.editor.project.open(e)},closeProject:function(){t.editor.project.close()},exportProject:function(){return t.editor.export.projectToData()}}}angular.module("app").factory("editorService",editorService),editorService.$inject=["$window"];
function nodejsService(e){var r=!!e.require,i=r?e.require("remote"):null;return{ok:r,fs:r?e.require("fs"):null,path:r?e.require("path"):null,dialog:r?i.require("dialog"):null}}angular.module("app").factory("nodejsService",nodejsService),nodejsService.$inject=["$window"];
function notificationService(i,e,o,s,a){var c=[];return{notify:function(i){t(i)},simple:function(i,n){t({title:i,message:n,type:"default"})},success:function(i,n){t({title:i,message:n,icon:"fa-check",type:"success"})},error:function(i,n){t({title:i,message:n,icon:"fa-close",type:"error"})},info:function(i,n){t({title:i,message:n,icon:"fa-info",type:"info"})},warning:function(i,n){t({title:i,message:n,icon:"fa-warning",type:"warning"})}};function l(){for(var i=20,n=c.length-1;0<=n;n--){var t=c[n],e=i,i=e+parseInt(t[0].offsetHeight)+10;t.css("bottom",e+"px")}}function t(i){i=tine.merge({},{type:"default",title:"",message:"",icon:!1,delay:3e3},i);var n=s.$new(),t=(n.type=i.type,n.title=a.trustAsHtml(i.title),n.message=a.trustAsHtml(i.message),n.icon=i.icon,n.delay=i.delay,o('<div class="notification" ng-class="type">  <div class="notification-icon" ng-show="icon"><i class="fa fa-fw" ng-class="icon"></i></div>  <div class="notification-content" ng-class="{\'has-icon\': icon}">    <div class="notification-title" ng-show="title" ng-bind-html="title"></div>    <div class="notification-message" ng-bind-html="message"></div>  </div></div>')(n));t.bind("webkitTransitionEnd oTransitionEnd otransitionend transitionend msTransitionEnd click",function(i){"click"!==(i=i.originalEvent||i).type&&!t.hasClass("killed")||(t.remove(),c.remove(t),l())}),angular.isNumber(i.delay)&&e(function(){t.addClass("killed")},i.delay),e(function(){t.addClass("started"),l()},0),c.push(t),angular.element(document.getElementsByTagName("body")).append(t)}}angular.module("app").factory("notificationService",notificationService),notificationService.$inject=["$window","$timeout","$compile","$rootScope","$sce"];
function systemService(e,t){var n=!!e.process;return{isDesktop:n,getDataPath:function(){{var e,r;return n?(e=process.env.APPDATA,r=i(e=e||process.env.HOME+"/.behavior3","b3editor"),s(e),s(r),r):"b3editor"}},join:i};function s(r){try{t.fs.statSync(r)}catch(e){t.fs.mkdirSync(r)}}function i(){if(n)return t.path.join.apply(t.path,arguments);for(var e=arguments[0],r=1;r<arguments.length;r++)e+="-"+arguments[r];return e}}angular.module("app").factory("systemService",systemService),systemService.$inject=["$window","nodejsService"];
angular.module("app").directive("blacklist",function(){return{require:"ngModel",restrict:"A",link:function(i,t,n,r){var e=n.blacklist.split(",");r.$parsers.unshift(function(i){var t=-1===e.indexOf(i);return r.$setValidity("blacklist",t),t?i:void 0}),r.$formatters.unshift(function(i){return r.$setValidity("blacklist",-1===e.indexOf(i)),i})}}});
function EditorController(){}angular.module("app").controller("EditorController",EditorController),EditorController.$inject=[];
(()=>{function o(o,e){var n=this;function t(){n.project=e.getProject()}n.project=null,t(),o.$on("dash-projectchanged",function(){t()})}angular.module("app").controller("DashController",o),o.$inject=["$scope","projectModel"]})();
(()=>{function o(){}angular.module("app").controller("HomeController",o),o.$inject=[]})();
(()=>{function e(t,n,r,e,c,i){var s=this;function u(){s.isDesktop=e.isDesktop,i.getRecentProjects().then(function(e){s.recentProjects=e})}function a(e,o){i.newProject(e,o).then(function(){t.go("editor")})}function l(e){i.openProject(e).then(function(){t.go("editor")},function(){c.error("Invalid file","Couldn't open the project file.")})}s.recentProjects=[],s.isDesktop=null,s.newProject=function(){function e(){r.prompt("New project",null,"input","Project name").then(function(o){var e;o?s.isDesktop?(e=o.replace(/\s+/g,"_").toLowerCase(),r.saveAs(e,[".b3",".json"]).then(function(e){a(e,o)})):a("b3projects-"+b3.createUUID(),o):c.error("Invalid name","You must provide a name for the project.")})}n.editor.isDirty()?r.confirm("Leave without saving?","If you proceed you will lose all unsaved modifications.",null,{closeOnConfirm:!1}).then(e):e()},s.openProject=function(e){function o(){e?l(e):r.openFile(!1,[".b3",".json"]).then(function(e){l(e)})}n.editor.isDirty()?r.confirm("Leave without saving?","If you proceed you will lose all unsaved modifications.").then(o):o()},s.editProject=function(){var o=i.getProject();r.prompt("Rename project",null,"input",o.name).then(function(e){e?(o.name=e,i.saveProject(o).then(function(){u(),c.success("Project renamed","The project has been renamed successfully.")})):c.error("Invalid name","You must provide a name for the project.")})},s.saveProject=function(){i.saveProject().then(function(){c.success("Project saved","The project has been saved")},function(){c.error("Error","Project couldn't be saved")})},s.closeProject=function(){function e(){i.closeProject()}n.editor.isDirty()?r.confirm("Leave without saving?","If you proceed you will lose all unsaved modifications.",null).then(e):e()},s.removeProject=function(e){r.confirm("Remove project?","Are you sure you want to remove this project?").then(function(){i.removeProject(e).then(function(){u(),c.success("Project removed","The project has been removed from editor.")})})},u()}angular.module("app").controller("ProjectsController",e),e.$inject=["$state","$window","dialogService","systemService","notificationService","projectModel"]})();
(()=>{function t(t,e,n){var s=this;function i(){e.getSettings().then(function(t){s.settings=t})}s.settings={},s.saveSettings=function(){e.saveSettings(s.settings).then(function(){t.success("Settings saved","The editor settings has been updated.")})},s.resetSettings=function(){n.confirm("Reset Settings?","Are you sure you want to reset to the default settings?").then(function(){e.resetSettings().then(function(){t.success("Settings reseted","The editor settings has been updated to default values."),i()})})},i()}angular.module("app").controller("SettingsController",t),t.$inject=["notificationService","settingsModel","dialogService"]})();
function fileStorageService(e){var r=e.ok,t=e.fs;return{ok:r,save:function(e,r){if("string"!=typeof r)try{r=JSON3.stringify(r)}catch(e){}var n=t.openSync(e+"~","w");t.writeSync(n,r),t.closeSync(n),t.rename(e+"~",e)},load:function(e){e=t.readFileSync(e,"utf-8");try{e=JSON3.parse(e)}catch(e){}return e},remove:function(e){}}}angular.module("app").factory("fileStorageService",fileStorageService),fileStorageService.$inject=["nodejsService"];
function localStorageService(a){return{ok:!!a.localStorage,save:function(e,o){try{o=JSON.stringify(o)}catch(e){}a.localStorage[e]=o},load:function(e){e=a.localStorage[e];try{e=JSON.parse(e)}catch(e){}return e},remove:function(e){delete a.localStorage[e]}}}angular.module("app").factory("localStorageService",localStorageService),localStorageService.$inject=["$window"];
function storageService(e,r,n){var c=n.ok?n:r;return{save:function(e,r){c.save(e,r)},saveAsync:function(n,t){return e(function(e,r){try{c.save(n,t),e()}catch(e){r(e)}})},load:function(e){return c.load(e)},loadAsync:function(n){return e(function(e,r){try{e(c.load(n))}catch(e){r(e)}})},remove:function(e){c.remove(e)},removeAsync:function(n){return e(function(e,r){try{c.remove(n),e()}catch(e){r(e)}})}}}angular.module("app").factory("storageService",storageService),storageService.$inject=["$q","localStorageService","fileStorageService"];
var editor;function startApp(){document.getElementById("page-preload");editor=new b3e.editor.Editor,angular.bootstrap(document,["app"])}